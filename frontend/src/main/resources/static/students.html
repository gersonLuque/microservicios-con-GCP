<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Centro de estudiantes</h1>
        
        <h2>Lista de estudiantes</h2>
        <table class="table table-striped table-bordered" id="studentsTable">
          <thead class="thead-dark">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Email</th>
              <th>Numero de curso</th>
            </tr>
          </thead>
          <tbody id="studentsBody">
          </tbody>
        </table>

        <h2>Lista de ficheros</h2>
        <button id="listFilesButton" class="btn btn-primary mb-3">List Files</button>
        <ul id="fileList" class="list-group mb-4"></ul>

        <h2>Subir archivo</h2>
        <form id="uploadForm" class="mb-4">
            <div class="form-group">
                <input type="file" id="fileInput" name="file" class="form-control-file">
            </div>
            <button type="button" class="btn btn-success" onclick="uploadFile()">Upload</button>
        </form>
        <div id="message" class="alert" style="display: none;"></div>

        <h2>Descargar archivo</h2>
        <form id="downloadForm" class="mb-4">
            <div class="form-group">
                <label for="fileName">Enter File Name:</label>
                <input type="text" id="fileName" name="fileName" class="form-control">
            </div>
            <button type="submit" class="btn btn-info">Download</button>
        </form>
        <div id="downloadLink" class="download-link" style="display: none"></div>
    </div>

    <script>
      const baseUrl = "http://localhost:8080/api/student";

      async function fetchStudents() {
        try {
          const response = await fetch(`${baseUrl}/all`);
          const students = await response.json();
          displayStudents(students);
        } catch (error) {
          console.error("Error fetching students:", error);
        }
      }

      function displayStudents(students) {
        const studentsBody = document.getElementById("studentsBody");
        studentsBody.innerHTML = "";
        students.forEach((student) => {
          const row = `<tr>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${student.lastName}</td>
                        <td>${student.email}</td>
                        <td>${student.courseId}</td>
                      </tr>`;
          studentsBody.innerHTML += row;
        });
      }

      document.getElementById("downloadForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const fileName = document.getElementById("fileName").value.trim();
        if (!fileName) {
          alert("Please enter a file name.");
          return;
        }

        const downloadUrl = `${baseUrl}/file/${fileName}`;
        window.location.href = downloadUrl;
      });

      fetchStudents();

      async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            alert("Please select a file.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch(`${baseUrl}/upload`, {
                method: 'POST',
                body: formData
            });

            const message = document.getElementById('message');
            message.style.display = 'block';

            if (response.ok) {
                const result = await response.text();
                message.className = 'alert alert-success';
                message.innerText = "File uploaded successfully: " + result;
            } else {
                message.className = 'alert alert-danger';
                message.innerText = "Failed to upload file: " + response.statusText;
            }
        } catch (error) {
            console.error("Error uploading file:", error);
            const message = document.getElementById('message');
            message.className = 'alert alert-danger';
            message.innerText = "Error uploading file: " + error;
        }
      }

      document.getElementById('listFilesButton').addEventListener('click', async () => {
        try {
            const response = await fetch(`${baseUrl}/files`);
            if (response.ok) {
                const fileNames = await response.json();
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                fileNames.forEach(fileName => {
                    const listItem = document.createElement('li');
                    listItem.textContent = fileName;
                    listItem.className = 'list-group-item';
                    fileList.appendChild(listItem);
                });
            } else {
                alert('Failed to list files');
            }
        } catch (error) {
            console.error('Error fetching file list:', error);
            alert('Error fetching file list');
        }
      })
    </script>
</body>
</html>
